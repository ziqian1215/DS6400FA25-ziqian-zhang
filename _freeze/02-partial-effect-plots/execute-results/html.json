{
  "hash": "c151046131e0336df33985d3615353a6",
  "result": {
    "engine": "knitr",
    "markdown": "# Model Visualization\n\n## Data Generation\n\nWe generate data from the model:\n\n$$\nE[Y \\mid X] = \\sqrt{5}\\,\\sigma(X_1 + X_3) + \\sqrt{5}\\,\\sigma(X_2)\\,X_3, \\quad\nV[Y \\mid X]=1,\n$$\n\nwhere $X_1,X_2 \\sim \\mathcal N(0,1)$, $X_3 \\sim \\text{Bernoulli}(0.4)$, and $\\sigma(x)=1/(1+e^{-x})$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n\nset.seed(42)\nn  <- 2000\nX1 <- rnorm(n)\nX2 <- rnorm(n)\nX3 <- rbinom(n, 1, 0.4)\n\nsigmoid <- function(x) 1 / (1 + exp(-x))\nmu <- sqrt(5) * sigmoid(X1 + X3) + sqrt(5) * sigmoid(X2) * X3\nY  <- mu + rnorm(n, 0, 1)\n\ndat <- tibble(X1, X2, X3 = factor(X3), Y)\nhead(dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 4\n      X1     X2 X3        Y\n   <dbl>  <dbl> <fct> <dbl>\n1  1.37   0.251 0      1.85\n2 -0.565 -0.278 0      1.78\n3  0.363 -1.72  0      1.63\n4  0.633 -2.01  0      1.32\n5  0.404 -1.29  0      1.01\n6 -0.106  0.366 1      2.79\n```\n\n\n:::\n:::\n\n## Model: Linear Regression with Natural Splines\n\nWe model a flexible, nonlinear relationship by replacing raw predictors with **natural cubic spline** bases.  \nLet $f_1(\\cdot)$ and $f_2(\\cdot)$ be smooth functions represented by spline bases. We fit\n\n$$\nY \\;=\\; \\beta_0 \\;+\\; f_1(X_1)\\;+\\; f_2(X_2)\\\\;+\\; \\gamma\\,\\mathbb{1}(X_3)\\;+\\; \\varepsilon,\n\\quad \\varepsilon \\sim \\mathcal{N}(0,\\sigma^2).\n$$\n\n- `ns(X1, df=5)` and `ns(X2, df=5)` are **natural spline** bases with 5 degrees of freedom.  \n- `ns(X3, df=3)` effectively lets the model represent it smoothly if treated as numeric, but it’s basically equivalent to a categorical main effect.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(splines)\nlm_spline <- lm(\n  Y ~ ns(X1, df = 5) + ns(X2, df = 5) + ns(as.numeric(X3), df = 3),\n  data = dat\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in ns(as.numeric(X3), df = 3): shoving 'interior' knots matching\nboundary knots to inside\n```\n\n\n:::\n:::\n\n## Partial Effect Plots\n\n**What is a partial effect plot?**  \nFor an `lm` with splines, a partial effect (component-plus-residual) plot shows how a predictor contributes to the fitted values **after adjusting for all other terms**. We compute the **term contribution** for a variable (from `predict(mod, type = \"terms\")`), add the model residuals to form **partial residuals**, and plot those against the raw predictor. A smooth (LOESS) curve with a confidence band visualizes the nonlinear effect learned by the spline.\n\n### Helper functions\n\nThe two helpers below produce ggplot figures:\n- `simple_peplot()` — single numeric predictor\n- `simple_peplot_by()` — numeric predictor split into separate curves by a factor (e.g., `X3`)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimple_peplot <- function(mod, var, data, span = 0.8) {\n  tt <- predict(mod, type = \"terms\")\n  cn <- colnames(tt)\n  pick <- grep(paste0(\"\\\\b\", var, \"\\\\b\"), cn)\n  if (length(pick) == 0L) stop(\"No model terms matched '\", var, \"'.\")\n  term_contrib <- rowSums(tt[, pick, drop = FALSE])\n  pr <- term_contrib + residuals(mod)\n  x  <- data[[var]]\n\n  ggplot(tibble(x = x, pr = pr), aes(x, pr)) +\n    geom_point(alpha = 0.35, size = 1, color = \"steelblue\") +\n    geom_smooth(method = \"loess\", span = span, se = TRUE, linewidth = 1.1) +\n    labs(x = var, y = \"Partial residual\", title = paste(\"Partial effect of\", var)) +\n    theme_bw(base_size = 12)\n}\n\nsimple_peplot_by <- function(mod, var, by, data, span = 0.8) {\n  tt <- predict(mod, type = \"terms\")\n  pick <- grep(paste0(\"\\\\b\", var, \"\\\\b\"), colnames(tt))\n  stopifnot(length(pick) > 0)\n  term_contrib <- rowSums(tt[, pick, drop = FALSE])\n  pr <- term_contrib + residuals(mod)\n\n  df <- tibble(x = data[[var]], pr = pr, grp = data[[by]])\n\n  ggplot(df, aes(x, pr, color = grp)) +\n    geom_point(alpha = 0.3, size = 1) +\n    geom_smooth(method = \"loess\", span = span, se = TRUE, linewidth = 1.1) +\n    labs(x = var, y = \"Partial residual\",\n         title = paste(\"Partial effect of\", var, \"by\", by), color = by) +\n    theme_bw(base_size = 12)\n}\n```\n:::\n\n## Final Plots\n\nNow we put everything together: plotting the **partial effects** of our spline-based linear regression.\n\n::: {.cell}\n\n```{.r .cell-code}\nsimple_peplot(lm_spline, \"X1\", data = dat)\n```\n\n::: {.cell-output-display}\n![](02-partial-effect-plots_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\nsimple_peplot(lm_spline, \"X2\", data = dat)\n```\n\n::: {.cell-output-display}\n![](02-partial-effect-plots_files/figure-html/unnamed-chunk-4-2.png){width=672}\n:::\n\n```{.r .cell-code}\nsimple_peplot_by(lm_spline, var = \"X1\", by = \"X3\", data = dat)\n```\n\n::: {.cell-output-display}\n![](02-partial-effect-plots_files/figure-html/unnamed-chunk-4-3.png){width=672}\n:::\n\n```{.r .cell-code}\nsimple_peplot_by(lm_spline, var = \"X2\", by = \"X3\", data = dat)\n```\n\n::: {.cell-output-display}\n![](02-partial-effect-plots_files/figure-html/unnamed-chunk-4-4.png){width=672}\n:::\n:::\n\n## Random Forest with Partial Dependence Plots\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(pdp)            \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'pdp'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:purrr':\n\n    partial\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(patchwork) \nlibrary(randomForest) \n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nrandomForest 4.7-1.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nType rfNews() to see new features/changes/bug fixes.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'randomForest'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:dplyr':\n\n    combine\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:ggplot2':\n\n    margin\n```\n\n\n:::\n\n```{.r .cell-code}\nrf <- randomForest(Y ~ X1 + X2 + X3, data = dat, ntree = 500, mtry = 2, importance = TRUE)\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\npstyle <- function(p, title) p + labs(title = title, x = NULL, y = \"Partial dependence\") +\n  theme_bw(base_size = 12)\n\np_rf_x1 <- partial(rf, pred.var = \"X1\", grid.resolution = 60, train = dat)     |> autoplot() |> pstyle(\"RF: effect of X1\")\np_rf_x2 <- partial(rf, pred.var = \"X2\", grid.resolution = 60, train = dat)     |> autoplot() |> pstyle(\"RF: effect of X2\")\np_rf_x3 <- partial(rf, pred.var = \"X3\", grid.resolution = 2,  train = dat)     |> autoplot() |> pstyle(\"RF: effect of X3\")\n\n# Spline-Linear PDPs\np_lm_x1 <- partial(lm_spline, pred.var = \"X1\", grid.resolution = 60, train = dat) |> autoplot() |> pstyle(\"Spline-LM: effect of X1\")\np_lm_x2 <- partial(lm_spline, pred.var = \"X2\", grid.resolution = 60, train = dat) |> autoplot() |> pstyle(\"Spline-LM: effect of X2\")\np_lm_x3 <- partial(lm_spline, pred.var = \"X3\", grid.resolution = 2,  train = dat) |> autoplot() |> pstyle(\"Spline-LM: effect of X3\")\n\n(p_rf_x1 | p_rf_x2 | p_rf_x3) /\n(p_lm_x1 | p_lm_x2 | p_lm_x3)\n```\n\n::: {.cell-output-display}\n![](02-partial-effect-plots_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\npstyle <- function(p, title) p +\n  labs(title = title, x = NULL, y = \"Partial dependence\") +\n  theme_bw(base_size = 12)\n\np_rf_x1_x3 <- partial(rf, pred.var = c(\"X1\", \"X3\"), grid.resolution = 60, train = dat) |>\n  autoplot(rug = FALSE, contour = FALSE) |> pstyle(\"RF: effect of X1 by X3\")\n\np_rf_x2_x3 <- partial(rf, pred.var = c(\"X2\", \"X3\"), grid.resolution = 60, train = dat) |>\n  autoplot(rug = FALSE, contour = FALSE) |> pstyle(\"RF: effect of X2 by X3\")\n\np_rf_x1_x3 / p_rf_x2_x3\n```\n\n::: {.cell-output-display}\n![](02-partial-effect-plots_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n## Individual Conditional Expectation (ICE) plots\n\nICE shows one curve **per observation**, revealing heterogeneity that PDP/PE can hide.\n\n::: {.cell}\n\n```{.r .cell-code}\n# ---- helpers styled like pstyle() \npstyle_fx <- function(p, title, xlab, ylab) {\n  p + labs(title = title, x = xlab, y = ylab) + theme_bw(base_size = 12)\n}\n\n# ---- ICE\nplot_ice <- function(model, data, var, grid.size = 60, title = NULL) {\n  grid_vals <- seq(min(data[[var]]), max(data[[var]]), length.out = grid.size)\n\n  ice_data <- purrr::map_dfr(seq_len(nrow(data)), function(i) {\n    new_dat <- data[rep(i, grid.size), ]\n    new_dat[[var]] <- grid_vals\n    tibble(\n      ID   = i,\n      x    = grid_vals,\n      yhat = as.numeric(predict(model, newdata = new_dat))\n    )\n  })\n\n  pdp_data <- ice_data |>\n    dplyr::group_by(x) |>\n    dplyr::summarise(mean_y = mean(yhat), .groups = \"drop\")\n\n  g <- ggplot(ice_data, aes(x = x, y = yhat, group = ID)) +\n    geom_line(alpha = 0.18, linewidth = 0.4, color = \"steelblue\") +\n    geom_line(data = pdp_data, aes(x = x, y = mean_y),\n              inherit.aes = FALSE, color = \"red\", linewidth = 1.1)\n\n  pstyle_fx(g, title %||% paste0(\"ICE: \", var), xlab = var, ylab = \"Predicted Y\")\n}\n\n# ---- ICE by a factor (e.g., X3) ----\nplot_ice_by <- function(model, data, var, by, grid.size = 60, title = NULL) {\n  grid_vals <- seq(min(data[[var]]), max(data[[var]]), length.out = grid.size)\n\n  ice_data <- purrr::map_dfr(seq_len(nrow(data)), function(i) {\n    new_dat <- data[rep(i, grid.size), ]\n    new_dat[[var]] <- grid_vals\n    tibble(\n      ID   = i,\n      grp  = new_dat[[by]][1],\n      x    = grid_vals,\n      yhat = as.numeric(predict(model, newdata = new_dat))\n    )\n  })\n\n  pdp_data <- ice_data |>\n    dplyr::group_by(grp, x) |>\n    dplyr::summarise(mean_y = mean(yhat), .groups = \"drop\")\n\n  g <- ggplot(ice_data, aes(x = x, y = yhat, group = interaction(ID, grp), color = grp)) +\n    geom_line(alpha = 0.18, linewidth = 0.35) +\n    geom_line(data = pdp_data, aes(x = x, y = mean_y, color = grp),\n              inherit.aes = FALSE, linewidth = 1.05)\n\n  pstyle_fx(g, title %||% paste0(\"ICE: \", var, \" by \", by), xlab = var, ylab = \"Predicted Y\")\n}\n```\n:::\n\n\n## Accumulated Local Effects (ALE) plots\n\nALE curves summarize local effects and are often more reliable than PDP when features are correlated.\n\n::: {.cell}\n\n```{.r .cell-code}\n# ---- ALE (no extra packages) ----\nplot_ale <- function(model, data, var, grid.size = 40, title = NULL) {\n  qs <- stats::quantile(data[[var]], probs = seq(0, 1, length.out = grid.size), names = FALSE)\n  mids <- (qs[-1] + qs[-length(qs)]) / 2\n\n  delta <- numeric(length(qs) - 1)\n  for (k in seq_len(length(delta))) {\n    low  <- qs[k]; high <- qs[k + 1]\n    idx <- which(data[[var]] >= low & data[[var]] < high)\n    if (length(idx)) {\n      dat_low  <- data[idx, ];  dat_low[[var]]  <- low\n      dat_high <- data[idx, ]; dat_high[[var]] <- high\n      delta[k] <- mean(predict(model, dat_high) - predict(model, dat_low))\n    } else {\n      delta[k] <- 0\n    }\n  }\n\n  ale <- cumsum(delta)\n  ale <- ale - mean(ale)\n\n  g <- ggplot(tibble(x = mids, y = ale), aes(x, y)) +\n    geom_line(linewidth = 1.1)\n\n  pstyle_fx(g, title %||% paste0(\"ALE: \", var), xlab = var, ylab = \"Accumulated local effect\")\n}\n```\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ICE / ALE for the spline model\nice_x1 <- plot_ice(lm_spline, dat, \"X1\", grid.size = 60, title = \"ICE: X1 (Spline-LM)\")\nice_x2 <- plot_ice(lm_spline, dat, \"X2\", grid.size = 60, title = \"ICE: X2 (Spline-LM)\")\n\nale_x1 <- plot_ale(lm_spline, dat, \"X1\", grid.size = 40, title = \"ALE: X1 (Spline-LM)\")\nale_x2 <- plot_ale(lm_spline, dat, \"X2\", grid.size = 40, title = \"ALE: X2 (Spline-LM)\")\n\nice_x2_byx3 <- plot_ice_by(lm_spline, dat, var = \"X2\", by = \"X3\", grid.size = 60,\n                           title = \"ICE: X2 by X3 (Spline-LM)\")                        \nice_x1_byx3 <- plot_ice_by(lm_spline, dat, var = \"X1\", by = \"X3\", grid.size = 60,\n                           title = \"ICE: X1 by X3 (Spline-LM)\")                           \n\n# Arrange like your PDP grid\n(ice_x1 | ice_x2) /\n(ale_x1 | ale_x2)\n```\n\n::: {.cell-output-display}\n![](02-partial-effect-plots_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Show the grouped ICE as well\nice_x1_byx3\n```\n\n::: {.cell-output-display}\n![](02-partial-effect-plots_files/figure-html/unnamed-chunk-10-2.png){width=672}\n:::\n\n```{.r .cell-code}\nice_x2_byx3\n```\n\n::: {.cell-output-display}\n![](02-partial-effect-plots_files/figure-html/unnamed-chunk-10-3.png){width=672}\n:::\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ICE for RF\nice_rf_x1 <- plot_ice(rf,  dat, \"X1\", grid.size = 60, title = \"ICE: X1 (Random Forest)\")\nice_rf_x2 <- plot_ice(rf,  dat, \"X2\", grid.size = 60, title = \"ICE: X2 (Random Forest)\")\n\n# ICE by X3 for RF\nice_rf_x1_byx3 <- plot_ice_by(rf, dat, var = \"X1\", by = \"X3\", grid.size = 60,\n                              title = \"ICE: X1 by X3 (Random Forest)\")\nice_rf_x2_byx3 <- plot_ice_by(rf, dat, var = \"X2\", by = \"X3\", grid.size = 60,\n                              title = \"ICE: X2 by X3 (Random Forest)\")\n\n# ALE for RF\nale_rf_x1 <- plot_ale(rf,  dat, \"X1\", grid.size = 40, title = \"ALE: X1 (Random Forest)\")\nale_rf_x2 <- plot_ale(rf,  dat, \"X2\", grid.size = 40, title = \"ALE: X2 (Random Forest)\")\n\n# --- Arrange with patchwork (optional) ---\nlibrary(patchwork)\n\n# Side-by-side ICE and ALE for RF\n(ice_rf_x1 | ice_rf_x2) /\n(ale_rf_x1 | ale_rf_x2)\n```\n\n::: {.cell-output-display}\n![](02-partial-effect-plots_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Grouped ICE by X3\nice_rf_x1_byx3\n```\n\n::: {.cell-output-display}\n![](02-partial-effect-plots_files/figure-html/unnamed-chunk-11-2.png){width=672}\n:::\n\n```{.r .cell-code}\nice_rf_x2_byx3\n```\n\n::: {.cell-output-display}\n![](02-partial-effect-plots_files/figure-html/unnamed-chunk-11-3.png){width=672}\n:::\n:::\n",
    "supporting": [
      "02-partial-effect-plots_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}